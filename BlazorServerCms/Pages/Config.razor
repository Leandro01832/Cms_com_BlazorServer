@page "/config"
@attribute [Authorize(Roles = "Admin")]
@inject NavigationManager navigation
@inject RepositoryPagina repositoryPagina

<p>Configurações de filtro</p>
@if (Mensagem != null)
{
    <div class="container">


        <p> <a href="/crud/livro">livros</a>                  </p>
        <p> <a href="/crud/story">stories</a>                 </p>
        <p> <a href="/crud/sub-story">sub-stories</a>         </p>
        <p> <a href="/crud/grupo">grupos</a>                  </p>
        <p> <a href="/crud/sub-grupo">sub-grupos</a>          </p>
        <p> <a href="/crud/sub-sub-grupo">sub-sub-grupos</a>  </p>
        <p> <a href="/crud/camadaseis">camada seis</a>        </p>
        <p> <a href="/crud/camadasete">camada sete</a>        </p>
        <p> <a href="/crud/camadaoito">camada oito</a>        </p>
        <p> <a href="/crud/camadanove">camada nove</a>        </p>
        <p> <a href="/crud/camadadez">camada dez</a>      </p>
        <p>Mensagem</p><br />
        <p><a class="btn btn-danger" href="/story/create">Criar story</a></p>
    </div>
}
else
{
    <div class="container">
        <p><a href="/crud/livro">livros</a>                  </p>
        <p><a href="/crud/story">stories</a>                </p>
        <p><a href="/crud/sub-story">sub-stories</a>         </p>
        <p><a href="/crud/grupo">grupos</a>                  </p>
        <p><a href="/crud/sub-grupo">sub-grupos</a>          </p>
        <p><a href="/crud/sub-sub-grupo">sub-sub-grupos</a>  </p>
        <p><a href="/crud/camadaseis">camada seis</a>        </p>
        <p><a href="/crud/camadasete">camada sete</a>        </p>
        <p><a href="/crud/camadaoito">camada oito</a>        </p>
        <p><a href="/crud/camadanove">camada nove</a>        </p>
        <p><a href="/crud/camadadez">camada dez</a>      </p>
    </div>
}

<br />
<br />
<br />

<p>Configurações de conteudo</p>
<div class="container">
    <p><a href="config/download-capitulo">Download de capitulo</a> </p>

</div>
<h3>Upload de videos do youtube do usuario</h3>
<EditForm Model="data" OnSubmit="@HandleSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <p>
        <label>Story:</label>
        <select @bind="data.StoryId">

            @foreach (var item in lista)
            {
                <option value="@item.Id" id="option@(item.Id)">@item.CapituloComNome</option>
            }
        </select>
    </p>

    <p>
        <label>Nome:</label>
        <InputText id="Nome" @bind-Value="data.Usuario" />
    </p>

    <p><button type="submit">Adicionar videos</button></p>
</EditForm>


@code {
    
    DataForm data = new DataForm();
    string Mensagem;
    List<Story> lista = new List<Story>();
    public ApplicationDbContext Context = new ApplicationDbContext(ApplicationDbContext._connectionString);

    protected override async Task OnInitializedAsync()
    {
        lista = await Context.Story!
           .Where(str => str.Nome != "Padrao" && !str.Comentario).ToListAsync();

        if (lista.Count == 0)
        {
            Mensagem = "Crie seu primeiro story!!!";

        }
        data.StoryId = lista.First().Id;
    }

    private async void HandleSubmit()
    {
        var story = await Context.Story!.FirstAsync(str => str.Id == data.StoryId);
        var cap = story.PaginaPadraoLink;
        Pagina pag = null;
        if (data.Usuario.Contains("@"))
            data.Usuario.Replace("@", "");

        var url = $"https://www.youtube.com/@{data.Usuario}/shorts";

        var html = await repositoryPagina!.Verificar(url);

        var arr = html.Split('"');

        foreach (var texto in arr)
        {
            if (texto.Contains("/shorts/"))
            {
                var text = texto.Replace("shorts", "embed");
                text += "?autoplay=1";
                if (cap != 0)
                {
                    pag = await Context!.Pagina!.Include(pa => pa!.Story!)
                   .FirstOrDefaultAsync(pa => pa!.Content == null &&
                   pa!.Produto! == null && pa!.Story!.PaginaPadraoLink == cap);
                    if (pag == null)
                        break;

                    pag.Content = $"<iframe width='320' height='560' src='https://www.youtube.com{text}' " +
                        "frameborder='0' title='video' allow='accelerometer; autoplay; clipboard-write; encrypted-media; " +
                        "gyroscope; picture-in-picture; web-share' allowfullscreen ></iframe>";

                    Context.Update(pag);
                    Context.SaveChanges();
                }
                else
                {
                    pag = await Context.Pagina.Include(pa => pa.Story!)
                .FirstOrDefaultAsync(pa => pa!.Content == null && pa!.Produto! == null);
                    if (pag == null)
                        break;

                    
                    pag.Content = $"<iframe width='320' height='560' src='https://www.youtube.com{text}' " +
                        "frameborder='0' title='video' allow='accelerometer; autoplay; clipboard-write; encrypted-media; " +
                        "gyroscope; picture-in-picture; web-share' allowfullscreen ></iframe>";

                    Context.Update(pag);
                    Context.SaveChanges();
                }
            }
        }

        if (pag != null)
            Mensagem = ObterMensagem(pag.StoryId);

        if (repositoryPagina.paginas! != null)
        repositoryPagina.paginas!.RemoveAll(p => p.Story!.PaginaPadraoLink == cap);
        
        if (pag != null)
        navigation.NavigateTo($"/mensagem/{Mensagem}");
        else
            navigation.NavigateTo("/");
    }

    private string ObterMensagem(long StoryId)
    {
        var story = Context.Story!
        .Include(str => str.Pagina!)
        .Include(str => str.Pagina!)
        .ThenInclude(str => str.Produto)
        .First(str => str.Id == StoryId);

        bool teste = false;
        foreach (var item in story.Pagina!)
            if (item.Content == null && item.Produto == null)
                teste = true;

        if (teste)
            return $"Existem paginas sem conteudo no capitulo {story.PaginaPadraoLink}";
        else
            return "Story Completo";
    }

    class DataForm
    {
        public long StoryId { get; set; }
        public string Usuario { get; set; }
    }
}
