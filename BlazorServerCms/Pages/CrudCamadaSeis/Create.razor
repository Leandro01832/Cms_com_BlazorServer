@page "/camadaseis/create"
@inject RepositoryPagina repositoryPagina
@inject NavigationManager navigation
@attribute [Authorize(Roles = "Admin")]

<EditForm Model="@exampleModel" OnSubmit="@HandleSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <p>
        <label>Nome:</label>
        <InputText id="Nome" @bind-Value="exampleModel.Nome" />
    </p>
    <p>
        <label>Story:</label>
        <select @bind="StoryId">
            @foreach (var item in lista)
            {
                <option value="@item.Id" id="option@(item.Id)">@item.Nome</option>
            }
        </select>
    </p>
    <p>
        <label>Sub-Story:</label>
        <select @bind="SubStoryId">
            @foreach (var item in SubStory!.Where(sub => sub.StoryId == StoryId))
            {
                <option value="@item.Id" id="option@(item.Id)">@item.Nome</option>
            }
        </select>
    </p>
    <p>
        <label>Grupo:</label>
        <select @bind="GrupoId">
            @foreach (var item in Grupo!.Where(sub => sub.SubStoryId == SubStoryId))
            {
                <option value="@item.Id" id="option@(item.Id)">@item.Nome</option>
            }
        </select>
    </p>
    <p>
        <label>Sub-Grupo:</label>
        <select @bind="SubGrupoId">
            @foreach (var item in SubGrupo!.Where(sub => sub.GrupoId == GrupoId))
            {
                <option value="@item.Id" id="option@(item.Id)">@item.Nome</option>
            }
        </select>
    </p>
    <p>
        <label>Sub-Sub-Grupo:</label>
        <select @bind="exampleModel.SubSubGrupoId">
            @foreach (var item in SubSubGrupo!.Where(sub => sub.SubGrupoId == SubGrupoId))
            {
                <option value="@item.Id" id="option@(item.Id)">@item.Nome</option>
            }
        </select>
    </p>
   
   

    <button type="submit">Adicionar</button>
</EditForm>

@code {
    private CamadaSeis exampleModel = new();

    long StoryId = 0;
    long SubStoryId = 0;
    long GrupoId = 0;
    long SubGrupoId = 0;
    private List<Story> lista = new List<Story>();
    public List<SubStory> SubStory = new List<SubStory>();
    public List<Grupo> Grupo = new List<Grupo>();
    public List<SubGrupo> SubGrupo = new List<SubGrupo>();
    public List<SubSubGrupo> SubSubGrupo = new List<SubSubGrupo>();

    protected override async Task OnInitializedAsync()
    {
        lista = await repositoryPagina.Context.Story!
        .Where(str => str.Nome != "Padrao").ToListAsync();
        StoryId = lista.First().Id;
        SubStory = await repositoryPagina.Context.SubStory!.ToListAsync();
        Grupo = await repositoryPagina.Context.Grupo!.ToListAsync();
        SubGrupo = await repositoryPagina.Context.SubGrupo!.ToListAsync();
        SubSubGrupo = await repositoryPagina.Context.SubSubGrupo!.ToListAsync();
    }

    private async void HandleSubmit()
    {
        var filtro = new Filtro
            {
                CamadaSeis = exampleModel,
                Nome = exampleModel.Nome,
                StoryId = StoryId,
                Rotas = exampleModel.Nome + ", "
            };
        await repositoryPagina.Context.AddAsync(filtro);
        await repositoryPagina.Context.SaveChangesAsync();
        filtro.CamadaSeisId = filtro.Id;
        repositoryPagina!.Context.Update(filtro);
        await repositoryPagina!.Context.SaveChangesAsync();
        navigation.NavigateTo("crud/camadaseis");
    }
}
